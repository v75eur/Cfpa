<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recensement des Apprenants - Électricité Bâtiment</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #7f8c8d;
            --border-radius: 10px;
            --box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--dark);
        }

        .container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            padding: 20px;
            width: 100%;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .app-logo {
            font-size: 3rem;
            margin-bottom: 15px;
            color: white;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-bottom: 25px;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1 1 300px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        input, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .btn-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        button {
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
            min-width: 150px;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .btn-save {
            background: var(--secondary);
        }

        .btn-save:hover {
            background: #2980b9;
        }

        .btn-submit {
            background: var(--success);
        }

        .btn-submit:hover {
            background: #27ae60;
        }

        .btn-copy {
            background: var(--warning);
        }

        .btn-copy:hover {
            background: #e67e22;
        }

        .btn-export {
            background: #9b59b6;
        }

        .btn-export:hover {
            background: #8e44ad;
        }

        .btn-danger {
            background: var(--accent);
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .password-container {
            position: relative;
            max-width: 400px;
            margin: 0 auto 20px;
        }

        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--gray);
        }

        #coffre, #horloge-content {
            display: none;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
            background-color: white;
            transition: var(--transition);
        }

        #coffre.show, #horloge-content.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .coffre-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
        }

        .coffre-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .students-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .students-table th, .students-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .students-table th {
            background-color: var(--light);
            font-weight: 600;
        }

        .students-table tr:hover {
            background-color: #f8f9fa;
        }

        .level-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .level-1 {
            background-color: #ffeaa7;
            color: #d35400;
        }

        .level-2 {
            background-color: #81ecec;
            color: #00cec9;
        }

        .level-3 {
            background-color: #fab1a0;
            color: #e17055;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #e2e8f0;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            background: white;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--accent);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        .review-panel {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .review-panel.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .review-item {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .review-value {
            font-weight: 600;
        }

        .level-section {
            margin-bottom: 30px;
        }

        .level-title {
            color: var(--primary);
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-level-btn {
            background: var(--secondary);
            padding: 5px 10px;
            font-size: 0.8rem;
            min-width: auto;
        }

        .section-title {
            color: var(--primary);
            padding: 8px 12px;
            background-color: #edf2f7;
            border-radius: var(--border-radius);
            margin: 15px 0 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-section-btn {
            background: var(--secondary);
            padding: 4px 8px;
            font-size: 0.7rem;
            min-width: auto;
        }

        .export-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .export-modal.show {
            display: flex;
        }

        .export-content {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .export-options {
            margin: 20px 0;
        }

        .export-option {
            margin-bottom: 15px;
        }

        .export-textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-family: monospace;
            resize: vertical;
        }

        .horloge-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--accent);
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 1001;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .horloge-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .horloge-input {
            flex: 1;
            min-width: 200px;
        }

        .horloge-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            header h1 {
                font-size: 2rem;
            }
            
            .students-table {
                display: block;
                overflow-x: auto;
            }
            
            .btn-container {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .coffre-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .coffre-actions {
                flex-wrap: wrap;
            }
            
            .horloge-form {
                flex-direction: column;
            }
        }

        footer {
            margin-top: 30px;
            color: white;
            text-align: center;
            opacity: 0.8;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="app-logo">
            <i class="fas fa-users"></i>
        </div>
        <h1>Recensement des Apprenants</h1>
        <p>Électricité Bâtiment - Classement par Niveau et Section</p>
    </header>

    <div class="card">
        <h2 class="card-title"><i class="fas fa-user-plus"></i> Formulaire d'Enregistrement</h2>
        <form id="studentForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="nom">Nom</label>
                    <input type="text" id="nom" placeholder="Nom de l'apprenant" required>
                </div>
                <div class="form-group">
                    <label for="prenom">Prénom</label>
                    <input type="text" id="prenom" placeholder="Prénom de l'apprenant" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="niveau">Niveau</label>
                    <select id="niveau" required onchange="updateSections()">
                        <option value="">Sélectionnez un niveau</option>
                        <option value="1">Niveau 1</option>
                        <option value="2">Niveau 2</option>
                        <option value="3">Niveau 3</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="section">Section</label>
                    <select id="section" required>
                        <option value="">Sélectionnez d'abord le niveau</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="contact">Contact(WhatsApp)</label>
                    <input type="tel" id="contact" placeholder="Numéro de téléphone" required>
                </div>
                <div class="form-group">
                    <label for="parentContact">Contact des parents(WhatsApp)</label>
                    <input type="tel" id="parentContact" placeholder="Contact des parents" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="ville">Ville de résidence</label>
                    <input type="text" id="ville" placeholder="Ville/quartier" required>
                </div>
            </div>
            
            <div class="btn-container">
                <button type="button" class="btn-save" onclick="enregistrerBrouillon()">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
                <button type="button" class="btn-submit" onclick="verifierAvantEnvoi()">
                    <i class="fas fa-paper-plane"></i> Envoyer
                </button>
            </div>
            
            <div id="reviewPanel" class="review-panel">
                <h3><i class="fas fa-check-circle"></i> Vérifiez attentivement les informations avant envoi définitif</h3>
                <p style="color: var(--accent); margin-bottom: 15px;">
                    <i class="fas fa-exclamation-triangle"></i> Vérifiez spécialement les numéros de téléphone pour éviter les erreurs.
                </p>
                <div class="review-item">
                    <span>Nom et Prénom:</span>
                    <span id="review-name" class="review-value"></span>
                </div>
                <div class="review-item">
                    <span>Niveau et Section:</span>
                    <span id="review-level-section" class="review-value"></span>
                </div>
                <div class="review-item">
                    <span>Contact:</span>
                    <span id="review-contact" class="review-value"></span>
                </div>
                <div class="review-item">
                    <span>Contact des parents:</span>
                    <span id="review-parent-contact" class="review-value"></span>
                </div>
                <div class="review-item">
                    <span>Ville de résidence:</span>
                    <span id="review-ville" class="review-value"></span>
                </div>
                
                <div class="btn-container">
                    <button type="button" class="btn-save" onclick="modifierInfos()">
                        <i class="fas fa-edit"></i> Modifier
                    </button>
                    <button type="button" class="btn-submit" onclick="envoyerDefinitif()">
                        <i class="fas fa-check-double"></i> Confirmer l'envoi
                    </button>
                </div>
                
                <p style="margin-top: 15px; font-style: italic; color: var(--warning);">
                    <i class="fas fa-exclamation-triangle"></i> Attention: Après confirmation, les informations ne pourront plus être modifiées.
                </p>
            </div>
        </form>
    </div>

    <div class="card">
        <h2 class="card-title"><i class="fas fa-lock"></i> Coffre des Apprenants (Accès Administrateur)</h2>
        <p style="text-align: center; margin-bottom: 20px;">Accès réservé à l'administrateur avec le mot de passe</p>
        
        <div class="password-container">
            <label for="coffre-password">Mot de passe administrateur</label>
            <input type="password" id="coffre-password" placeholder="Entrez le mot de passe">
            <span class="toggle-password" onclick="togglePassword('coffre-password', 'coffre-eye')">
                <i id="coffre-eye" class="far fa-eye"></i>
            </span>
        </div>
        
        <div style="text-align: center;">
            <button class="btn-save" onclick="ouvrirCoffre()">
                <i class="fas fa-unlock"></i> Ouvrir le coffre
            </button>
            <button class="btn-danger" onclick="fermerCoffre()" style="margin-top: 10px;">
                <i class="fas fa-lock"></i> Fermer le coffre
            </button>
        </div>

        <div id="coffre">
            <div class="coffre-header">
                <h3><i class="fas fa-users"></i> Liste des Apprenants Recensés</h3>
                <div class="coffre-actions">
                    <button class="btn-copy" onclick="copierTous()">
                        <i class="fas fa-copy"></i> Copier tous
                    </button>
                    <button class="btn-export" onclick="exporterDonnees()">
                        <i class="fas fa-file-export"></i> Exporter
                    </button>
                    <button class="btn-danger" onclick="demanderSuppression()">
                        <i class="fas fa-trash"></i> Supprimer tous
                    </button>
                </div>
            </div>
            
            <div id="coffreContent">
                <!-- Le contenu du coffre sera généré ici -->
            </div>
        </div>
    </div>

    <div class="card">
        <h2 class="card-title"><i class="fas fa-clock"></i> Horloge / Chronomètre</h2>
        <p style="text-align: center; margin-bottom: 20px;">Accès réservé avec mot de passe</p>
        
        <div class="password-container">
            <label for="horloge-password">Mot de passe horloge</label>
            <input type="password" id="horloge-password" placeholder="Entrez le mot de passe">
            <span class="toggle-password" onclick="togglePassword('horloge-password', 'horloge-eye')">
                <i id="horloge-eye" class="far fa-eye"></i>
            </span>
        </div>
        
        <div style="text-align: center;">
            <button class="btn-save" onclick="ouvrirHorloge()">
                <i class="fas fa-unlock"></i> Accéder à l'horloge
            </button>
        </div>

        <div id="horloge-content">
            <div class="form-row">
                <div class="form-group">
                    <label for="jours-delai">Jours de délai</label>
                    <input type="number" id="jours-delai" min="0" placeholder="Nombre de jours">
                </div>
                <div class="form-group">
                    <label for="heure-fin">Heure de fin (HH:MM)</label>
                    <input type="time" id="heure-fin">
                </div>
            </div>
            
            <div class="horloge-actions">
                <button class="btn-submit" onclick="lancerChrono()">
                    <i class="fas fa-play"></i> Lancer
                </button>
                <button class="btn-danger" onclick="arreterChrono()">
                    <i class="fas fa-stop"></i> Arrêter
                </button>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-save" onclick="fermerHorloge()">
                    <i class="fas fa-times"></i> Fermer l'horloge
                </button>
            </div>
        </div>
    </div>
</div>

<div id="notification" class="notification">
    <i class="fas fa-check-circle"></i>
    <span id="notification-text"></span>
</div>

<div id="exportModal" class="export-modal">
    <div class="export-content">
        <h3><i class="fas fa-file-export"></i> Exporter les données</h3>
        <div class="export-options">
            <div class="export-option">
                <label>
                    <input type="radio" name="exportOption" value="all" checked> Tous les apprenants
                </label>
            </div>
            <div class="export-option">
                <label>
                    <input type="radio" name="exportOption" value="level"> Par niveau
                </label>
                <select id="exportLevel" disabled>
                    <option value="1">Niveau 1</option>
                    <option value="2">Niveau 2</option>
                    <option value="3">Niveau 3</option>
                </select>
            </div>
            <div class="export-option">
                <label>
                    <input type="radio" name="exportOption" value="section"> Par section
                </label>
                <select id="exportSection" disabled>
                    <option value="1A">Niv1A</option>
                    <option value="1B">Niv1B</option>
                    <option value="1C">Niv1C</option>
                    <option value="2A">Niv2A</option>
                    <option value="2B">Niv2B</option>
                    <option value="2C">Niv2C</option>
                    <option value="3A">Niv3A</option>
                    <option value="3B">Niv3B</option>
                    <option value="3C">Niv3C</option>
                </select>
            </div>
        </div>
        <textarea id="exportData" class="export-textarea" readonly></textarea>
        <div class="btn-container">
            <button class="btn-save" onclick="telechargerFichier()">
                <i class="fas fa-download"></i> Télécharger
            </button>
            <button class="btn-copy" onclick="copierExport()">
                <i class="fas fa-copy"></i> Copier
            </button>
            <button class="btn-submit" onclick="fermerExport()">
                <i class="fas fa-times"></i> Fermer
            </button>
        </div>
    </div>
</div>

<div id="horloge-display" class="horloge-container" style="display: none;">
    <span id="temps-restant">00:00:00</span>
</div>

<div id="deleteModal" class="export-modal">
    <div class="export-content">
        <h3><i class="fas fa-trash"></i> Supprimer tous les recensements</h3>
        <p style="margin: 15px 0; color: var(--accent);">
            <i class="fas fa-exclamation-triangle"></i> Attention: Cette action est irréversible! Tous les apprenants enregistrés seront définitivement supprimés.
        </p>
        <div class="password-container">
            <label for="delete-password">Mot de passe de confirmation</label>
            <input type="password" id="delete-password" placeholder="Entrez le mot de passe">
            <span class="toggle-password" onclick="togglePassword('delete-password', 'delete-eye')">
                <i id="delete-eye" class="far fa-eye"></i>
            </span>
        </div>
        <div class="btn-container">
            <button class="btn-danger" onclick="supprimerTous()">
                <i class="fas fa-trash"></i> Confirmer la suppression
            </button>
            <button class="btn-submit" onclick="fermerDeleteModal()">
                <i class="fas fa-times"></i> Annuler
            </button>
        </div>
    </div>
</div>

<footer>
    <p>© 2023 - Centre de Formation Électricité Bâtiment</p>
</footer>

<script>
// Stockage des apprenants
let apprenants = JSON.parse(localStorage.getItem('apprenantsElectricite')) || [];
let currentDraft = null;
let intervalChrono = null;

// Fonction de hachage simple pour les mots de passe
function hashPassword(password) {
    // Utilisation d'une fonction de hachage simple mais efficace
    let hash = 0;
    for (let i = 0; i < password.length; i++) {
        const char = password.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
    }
    return hash.toString();
}

// Mots de passe hachés (stockés de manière sécurisée)
const hashedPasswordCoffre = hashPassword("Batel");
const hashedPasswordHorloge = hashPassword("logecfpa");
const hashedPasswordSuppression = hashPassword("telba");

// Éléments DOM
const notification = document.getElementById('notification');
const exportModal = document.getElementById('exportModal');
const exportData = document.getElementById('exportData');
const exportLevel = document.getElementById('exportLevel');
const exportSection = document.getElementById('exportSection');
const horlogeDisplay = document.getElementById('horloge-display');
const tempsRestant = document.getElementById('temps-restant');
const reviewPanel = document.getElementById('reviewPanel');
const deleteModal = document.getElementById('deleteModal');

// Basculer la visibilité du mot de passe
function togglePassword(inputId, eyeId) {
    const passwordInput = document.getElementById(inputId);
    const icon = document.getElementById(eyeId);
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.replace('fa-eye', 'fa-eye-slash');
    } else {
        passwordInput.type = 'password';
        icon.classList.replace('fa-eye-slash', 'fa-eye');
    }
}

// Mise à jour des sections en fonction du niveau sélectionné
function updateSections() {
    const niveau = document.getElementById('niveau').value;
    const sectionSelect = document.getElementById('section');
    
    sectionSelect.innerHTML = '<option value="">Sélectionnez une section</option>';
    
    if (niveau === '1') {
        sectionSelect.innerHTML += `
            <option value="A">Niv1A</option>
            <option value="B">Niv1B</option>
            <option value="C">Niv1C</option>
        `;
    } else if (niveau === '2') {
        sectionSelect.innerHTML += `
            <option value="A">Niv2A</option>
            <option value="B">Niv2B</option>
            <option value="C">Niv2C</option>
        `;
    } else if (niveau === '3') {
        sectionSelect.innerHTML += `
            <option value="A">Niv3A</option>
            <option value="B">Niv3B</option>
            <option value="C">Niv3C</option>
        `;
    }
}

// Gérer les options d'export
document.querySelectorAll('input[name="exportOption"]').forEach(radio => {
    radio.addEventListener('change', function() {
        exportLevel.disabled = this.value !== 'level';
        exportSection.disabled = this.value !== 'section';
        preparerExport();
    });
});

exportLevel.addEventListener('change', preparerExport);
exportSection.addEventListener('change', preparerExport);

// Préparer les données pour l'export
function preparerExport() {
    const option = document.querySelector('input[name="exportOption"]:checked').value;
    let data = "";
    
    if (option === 'all') {
        data = genererDonneesExport(apprenants, "TOUS LES APPRENANTS");
    } else if (option === 'level') {
        const niveau = exportLevel.value;
        const apprenantsNiveau = apprenants.filter(a => a.niveau === niveau);
        data = genererDonneesExport(apprenantsNiveau, `NIVEAU ${niveau}`);
    } else if (option === 'section') {
        const section = exportSection.value; // ex "2B"
        const niveau = section[0];
        const sectionLettre = section[1];
        const apprenantsSection = apprenants.filter(a => a.niveau === niveau && a.section === sectionLettre);
        data = genererDonneesExport(apprenantsSection, `NIV${niveau}${sectionLettre}`);
    }
    
    exportData.value = data;
}

// Générer les données d'export formatées
function genererDonneesExport(listeApprenants, titre) {
    if (listeApprenants.length === 0) {
        return `Aucun apprenant trouvé pour ${titre}`;
    }
    
    // Organiser par section si on exporte tous les apprenants ou un niveau entier
    const organiserParSection = titre === "TOUS LES APPRENANTS" || titre.startsWith("NIVEAU");
    
    let resultat = `LISTE DES APPRENANTS - ${titre}\n`;
    resultat += `Date d'export: ${new Date().toLocaleDateString('fr-FR')}\n`;
    resultat += "=".repeat(60) + "\n\n";
    
    if (organiserParSection) {
        // Organiser par sections
        const sections = {};
        
        listeApprenants.forEach(apprenant => {
            const sectionKey = `Niv${apprenant.niveau}${apprenant.section}`;
            if (!sections[sectionKey]) {
                sections[sectionKey] = [];
            }
            sections[sectionKey].push(apprenant);
        });
        
        // Trier les sections
        const sectionsTriees = Object.keys(sections).sort();
        
        for (const section of sectionsTriees) {
            resultat += `\n--- ${section} ---\n`;
            resultat += "N°\tNom\tPrénom\tContact\tContact Parents\tVille\tDate\n";
            
            sections[section].forEach((apprenant, index) => {
                resultat += `${index + 1}\t${apprenant.nom}\t${apprenant.prenom}\t${apprenant.contact}\t${apprenant.parentContact}\t${apprenant.ville}\t${apprenant.dateEnregistrement}\n`;
            });
            
            resultat += `Total ${section}: ${sections[section].length} apprenant(s)\n`;
        }
        
        resultat += `\nTOTAL GÉNÉRAL: ${listeApprenants.length} apprenant(s)`;
    } else {
        // Lister simplement pour une section spécifique
        resultat += "N°\tNom\tPrénom\tContact\tContact Parents\tVille\tDate\n";
        
        listeApprenants.forEach((apprenant, index) => {
            resultat += `${index + 1}\t${apprenant.nom}\t${apprenant.prenom}\t${apprenant.contact}\t${apprenant.parentContact}\t${apprenant.ville}\t${apprenant.dateEnregistrement}\n`;
        });
        
        resultat += `\nTotal: ${listeApprenants.length} apprenant(s)`;
    }
    
    return resultat;
}

// Exporter les données
function exporterDonnees() {
    preparerExport();
    exportModal.classList.add('show');
}

// Fermer la modal d'export
function fermerExport() {
    exportModal.classList.remove('show');
}

// Copier les données d'export
function copierExport() {
    exportData.select();
    document.execCommand('copy');
    showNotification('Données copiées dans le presse-papier !');
}

// Télécharger le fichier
function telechargerFichier() {
    const option = document.querySelector('input[name="exportOption"]:checked').value;
    let nomFichier = "apprenants";
    
    if (option === 'level') {
        nomFichier = `niveau_${exportLevel.value}`;
    } else if (option === 'section') {
        nomFichier = `niv${exportSection.value}`;
    }
    
    const blob = new Blob([exportData.value], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `recensement_${nomFichier}_${new Date().toISOString().slice(0, 10)}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('Fichier téléchargé avec succès !');
}

// Afficher une notification
function showNotification(message, isSuccess = true) {
    const icon = isSuccess ? 'fa-check-circle' : 'fa-exclamation-circle';
    notification.innerHTML = `<i class="fas ${icon}"></i> <span id="notification-text">${message}</span>`;
    notification.className = isSuccess ? 'notification success' : 'notification error';
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// Enregistrer un brouillon
function enregistrerBrouillon() {
    const formData = getFormData();
    
    if (!validateFormData(formData, false)) {
        return;
    }
    
    currentDraft = formData;
    showNotification('Brouillon enregistré. Vous pouvez modifier ou envoyer définitivement.');
}

// Vérifier avant envoi définitif
function verifierAvantEnvoi() {
    const formData = getFormData();
    
    if (!validateFormData(formData, true)) {
        return;
    }
    
    // Afficher le panneau de vérification
    document.getElementById('review-name').textContent = `${formData.nom} ${formData.prenom}`;
    document.getElementById('review-level-section').textContent = `Niveau ${formData.niveau} - Section ${formData.section}`;
    document.getElementById('review-contact').textContent = formData.contact;
    document.getElementById('review-parent-contact').textContent = formData.parentContact;
    document.getElementById('review-ville').textContent = formData.ville;
    
    reviewPanel.classList.add('show');
}

// Modifier les informations avant envoi
function modifierInfos() {
    reviewPanel.classList.remove('show');
}

// Envoyer définitivement
function envoyerDefinitif() {
    const formData = getFormData();
    
    // Ajouter l'apprenant
    apprenants.push({
        ...formData,
        niveauSection: `Niv${formData.niveau}${formData.section}`,
        dateEnregistrement: new Date().toLocaleDateString('fr-FR')
    });
    
    // Sauvegarder dans le localStorage
    localStorage.setItem('apprenantsElectricite', JSON.stringify(apprenants));
    
    // Réinitialiser le formulaire
    document.getElementById('studentForm').reset();
    currentDraft = null;
    reviewPanel.classList.remove('show');
    
    showNotification('Apprenant enregistré avec succès ! Merci pour votre participation.');
}

// Obtenir les données du formulaire
function getFormData() {
    return {
        nom: document.getElementById('nom').value.trim(),
        prenom: document.getElementById('prenom').value.trim(),
        niveau: document.getElementById('niveau').value,
        section: document.getElementById('section').value,
        contact: document.getElementById('contact').value.trim(),
        parentContact: document.getElementById('parentContact').value.trim(),
        ville: document.getElementById('ville').value.trim()
    };
}

// Valider les données du formulaire
function validateFormData(data, isFinal = false) {
    if (!data.nom || !data.prenom || !data.niveau || !data.section || !data.contact || !data.parentContact || !data.ville) {
        showNotification('Veuillez remplir tous les champs', false);
        return false;
    }

    if (isFinal) {
        // Validation supplémentaire pour l'envoi définitif
        if (data.contact === data.parentContact) {
            showNotification('Le contact et le contact des parents ne peuvent pas être identiques', false);
            return false;
        }
        
        // Validation des numéros de téléphone
        if (data.contact.length < 8) {
            showNotification('Le numéro de contact semble trop court', false);
            return false;
        }
        
        if (data.parentContact.length < 8) {
            showNotification('Le numéro de contact des parents semble trop court', false);
            return false;
        }
    }

    return true;
}

// Ouvrir le coffre avec le mot de passe
function ouvrirCoffre() {
    const passwordInput = document.getElementById('coffre-password').value;
    const hashedInput = hashPassword(passwordInput);

    if(hashedInput === hashedPasswordCoffre) {
        const coffre = document.getElementById('coffre');
        const coffreContent = document.getElementById('coffreContent');
        
        if (apprenants.length === 0) {
            coffreContent.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-user-slash"></i>
                    <h3>Aucun apprenant enregistré</h3>
                    <p>Le recensement n'a pas encore commencé</p>
                </div>
            `;
        } else {
            // Organiser les apprenants par niveau et section
            const apprenantsOrganises = {};
            
            // Initialiser la structure
            for (let niveau = 1; niveau <= 3; niveau++) {
                apprenantsOrganises[niveau] = {
                    'A': [],
                    'B': [],
                    'C': []
                };
            }
            
            // Remplir la structure
            apprenants.forEach(apprenant => {
                if (apprenantsOrganises[apprenant.niveau] && 
                    apprenantsOrganises[apprenant.niveau][apprenant.section]) {
                    apprenantsOrganises[apprenant.niveau][apprenant.section].push(apprenant);
                }
            });
            
            let html = '';
            
            // Générer le contenu pour chaque niveau et section
            for (let niveau = 1; niveau <= 3; niveau++) {
                let hasStudentsInLevel = false;
                
                // Vérifier s'il y a des étudiants dans ce niveau
                for (const section of ['A', 'B', 'C']) {
                    if (apprenantsOrganises[niveau][section].length > 0) {
                        hasStudentsInLevel = true;
                        break;
                    }
                }
                
                if (hasStudentsInLevel) {
                    html += `
                        <div class="level-section">
                            <div class="level-title">
                                <h3>Niveau ${niveau}</h3>
                                <button class="copy-level-btn" onclick="copierNiveau(${niveau})">
                                    <i class="fas fa-copy"></i> Copier Niveau ${niveau}
                                </button>
                            </div>
                    `;
                    
                    for (const section of ['A', 'B', 'C']) {
                        if (apprenantsOrganises[niveau][section].length > 0) {
                            html += `
                                <div class="section-title">
                                    <h4>Section ${section}</h4>
                                    <button class="copy-section-btn" onclick="copierSection(${niveau}, '${section}')">
                                        <i class="fas fa-copy"></i> Copier Section ${section}
                                    </button>
                                </div>
                                <table class="students-table">
                                    <thead>
                                        <tr>
                                            <th>N°</th>
                                            <th>Nom</th>
                                            <th>Prénom</th>
                                            <th>Contact</th>
                                            <th>Contact Parents</th>
                                            <th>Ville</th>
                                            <th>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            apprenantsOrganises[niveau][section].forEach((apprenant, index) => {
                                html += `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${apprenant.nom}</td>
                                        <td>${apprenant.prenom}</td>
                                        <td>${apprenant.contact}</td>
                                        <td>${apprenant.parentContact}</td>
                                        <td>${apprenant.ville}</td>
                                        <td>${apprenant.dateEnregistrement}</td>
                                    </tr>
                                `;
                            });
                            
                            html += `
                                    </tbody>
                                </table>
                                <p style="text-align: right; margin-bottom: 20px;">Total: ${apprenantsOrganises[niveau][section].length} apprenant(s)</p>
                            `;
                        }
                    }
                    
                    html += `</div>`;
                }
            }
            
            // Ajouter le total général
            html += `
                <div style="text-align: center; padding: 15px; background-color: #f8f9fa; border-radius: var(--border-radius);">
                    <h3>Total Général: ${apprenants.length} apprenant(s)</h3>
                </div>
            `;
            
            coffreContent.innerHTML = html;
        }
        
        coffre.classList.add('show');
        document.getElementById('coffre-password').value = '';
    } else {
        showNotification('Mot de passe incorrect !', false);
    }
}

// Fermer le coffre
function fermerCoffre() {
    document.getElementById('coffre').classList.remove('show');
    document.getElementById('coffre-password').value = '';
}

// Ouvrir l'horloge avec le mot de passe
function ouvrirHorloge() {
    const passwordInput = document.getElementById('horloge-password').value;
    const hashedInput = hashPassword(passwordInput);

    if(hashedInput === hashedPasswordHorloge) {
        document.getElementById('horloge-content').classList.add('show');
        document.getElementById('horloge-password').value = '';
    } else {
        showNotification('Mot de passe incorrect !', false);
    }
}

// Fermer l'horloge
function fermerHorloge() {
    document.getElementById('horloge-content').classList.remove('show');
    document.getElementById('horloge-password').value = '';
}

// Lancer le chronomètre
function lancerChrono() {
    // Arrêter tout chronomètre existant
    arreterChrono();
    
    const joursDelai = parseInt(document.getElementById('jours-delai').value) || 0;
    const heureFin = document.getElementById('heure-fin').value;
    
    if (!heureFin) {
        showNotification('Veuillez spécifier une heure de fin', false);
        return;
    }
    
    // Calculer la date/heure de fin
    const maintenant = new Date();
    const [heures, minutes] = heureFin.split(':').map(Number);
    
    let dateFin = new Date();
    dateFin.setDate(maintenant.getDate() + joursDelai);
    dateFin.setHours(heures, minutes, 0, 0);
    
    // Vérifier si la date de fin est dans le futur
    if (dateFin <= maintenant) {
        showNotification('La date/heure de fin doit être dans le futur', false);
        return;
    }
    
    // Afficher le compteur
    horlogeDisplay.style.display = 'block';
    
    // Mettre à jour le compteur immédiatement puis toutes les secondes
    function mettreAJourCompteur() {
        const maintenant = new Date();
        const différence = dateFin - maintenant;
        
        if (différence <= 0) {
            tempsRestant.textContent = "TEMPS ÉCOULÉ";
            clearInterval(intervalChrono);
            return;
        }
        
        // Calculer jours, heures, minutes, secondes
        const jours = Math.floor(différence / (1000 * 60 * 60 * 24));
        const heures = Math.floor((différence % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((différence % (1000 * 60 * 60)) / (1000 * 60));
        const secondes = Math.floor((différence % (1000 * 60)) / 1000);
        
        // Formater l'affichage
        let affichage = "";
        if (jours > 0) affichage += `${jours}j `;
        affichage += `${heures.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secondes.toString().padStart(2, '0')}`;
        
        tempsRestant.textContent = affichage;
    }
    
    mettreAJourCompteur();
    intervalChrono = setInterval(mettreAJourCompteur, 1000);
    
    showNotification('Chronomètre lancé !');
}

// Arrêter le chronomètre
function arreterChrono() {
    if (intervalChrono) {
        clearInterval(intervalChrono);
        intervalChrono = null;
    }
    horlogeDisplay.style.display = 'none';
    showNotification('Chronomètre arrêté');
}

// Copier tous les apprenants
function copierTous() {
    if (apprenants.length === 0) {
        showNotification('Aucun apprenant à copier', false);
        return;
    }
    
    const data = genererDonneesExport(apprenants, "TOUS LES APPRENANTS");
    
    // Copier dans le presse-papier
    navigator.clipboard.writeText(data)
        .then(() => {
            showNotification('Liste complète copiée dans le presse-papier !');
        })
        .catch(err => {
            showNotification('Erreur lors de la copie', false);
            console.error('Erreur de copie: ', err);
        });
}

// Copier un niveau spécifique
function copierNiveau(niveau) {
    const apprenantsNiveau = apprenants.filter(a => a.niveau === niveau.toString());
    
    if (apprenantsNiveau.length === 0) {
        showNotification(`Aucun apprenant dans le niveau ${niveau}`, false);
        return;
    }
    
    const data = genererDonneesExport(apprenantsNiveau, `NIVEAU ${niveau}`);
    
    navigator.clipboard.writeText(data)
        .then(() => {
            showNotification(`Liste du niveau ${niveau} copiée dans le presse-papier !`);
        })
        .catch(err => {
            showNotification('Erreur lors de la copie', false);
            console.error('Erreur de copie: ', err);
        });
}

// Copier une section spécifique
function copierSection(niveau, section) {
    const apprenantsSection = apprenants.filter(a => a.niveau === niveau.toString() && a.section === section);
    
    if (apprenantsSection.length === 0) {
        showNotification(`Aucun apprenant dans la section ${section} du niveau ${niveau}`, false);
        return;
    }
    
    const data = genererDonneesExport(apprenantsSection, `NIV${niveau}${section}`);
    
    navigator.clipboard.writeText(data)
        .then(() => {
            showNotification(`Liste de la section ${section} du niveau ${niveau} copiée dans le presse-papier !`);
        })
        .catch(err => {
            showNotification('Erreur lors de la copie', false);
            console.error('Erreur de copie: ', err);
        });
}

// Demander la suppression de tous les recensements
function demanderSuppression() {
    deleteModal.classList.add('show');
}

// Fermer la modal de suppression
function fermerDeleteModal() {
    deleteModal.classList.remove('show');
    document.getElementById('delete-password').value = '';
}

// Supprimer tous les recensements
function supprimerTous() {
    const passwordInput = document.getElementById('delete-password').value;
    const hashedInput = hashPassword(passwordInput);

    if(hashedInput === hashedPasswordSuppression) {
        // Supprimer tous les apprenants
        apprenants = [];
        localStorage.setItem('apprenantsElectricite', JSON.stringify(apprenants));
        
        // Fermer le coffre s'il est ouvert
        document.getElementById('coffre').classList.remove('show');
        
        // Fermer la modal
        fermerDeleteModal();
        
        showNotification('Tous les recensements ont été supprimés avec succès !');
    } else {
        showNotification('Mot de passe incorrect !', false);
    }
}
</script>
</body>
</html>
